"use strict";window.Game=function(){var e=300,t=700,s={INTRO:0,MOVE_LEFT:1,MOVE_RIGHT:2,LEVITATE:3,HIT_THE_MARK:4},i=[s.INTRO],a=i[0],r={ME:0,FIREBALL:1},n={OK:0,DISPOSED:1},h={NULL:0,LEFT:1,RIGHT:2,UP:4,DOWN:8},o={};o[r.ME]=function(s,i,a){i.keysPressed.UP&&s.y>0&&(s.direction=s.direction&~h.DOWN,s.direction=s.direction|h.UP,s.y-=s.speed*a*2,s.y<0&&(s.y=0)),i.keysPressed.UP||(s.y<e-s.height?(s.direction=s.direction&~h.UP,s.direction=s.direction|h.DOWN,s.y+=s.speed*a/3):s.Direction=s.direction&~h.DOWN),i.keysPressed.LEFT&&(s.direction=s.direction&~h.RIGHT,s.direction=s.direction|h.LEFT,s.x-=s.speed*a),i.keysPressed.RIGHT&&(s.direction=s.direction&~h.LEFT,s.direction=s.direction|h.RIGHT,s.x+=s.speed*a),s.y<0&&(s.y=0,s.Direction=s.direction&~h.DOWN,s.Direction=s.direction&~h.UP),s.y>e-s.height&&(s.y=e-s.height,s.Direction=s.direction&~h.DOWN,s.Direction=s.direction&~h.UP),s.x<0&&(s.x=0),s.x>t-s.width&&(s.x=t-s.width)},o[r.FIREBALL]=function(e,s,i){e.direction&h.LEFT&&(e.x-=e.speed*i),e.direction&h.RIGHT&&(e.x+=e.speed*i),(e.x<0||e.x>t)&&(e.state=n.DISPOSED)};var d={CONTINUE:0,WIN:1,FAIL:2,PAUSE:3,INTRO:4},c={};c[s.INTRO]=function(e){var t=e.garbage.filter(function(e){return e.type===r.FIREBALL});return t.length?d.WIN:d.CONTINUE};var u={};u[s.INTRO]=function(s){return s.objects.push({direction:h.RIGHT,height:84,speed:2,sprite:"img/wizard.gif",spriteReversed:"img/wizard-reversed.gif",state:n.OK,type:r.ME,width:61,x:t/3,y:e-100}),s};var f=function(e){this.container=e,this.canvas=document.createElement("canvas"),this.canvas.width=e.clientWidth,this.canvas.height=e.clientHeight,this.container.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this._onKeyDown=this._onKeyDown.bind(this),this._onKeyUp=this._onKeyUp.bind(this),this._pauseListener=this._pauseListener.bind(this),this.setDeactivated(!1)};return f.prototype={level:a,setDeactivated:function(e){this._deactivated!==e&&(this._deactivated=e,e?this._removeGameListeners():this._initializeGameListeners())},getInitialState:function(){return{currentStatus:d.CONTINUE,garbage:[],lastUpdated:null,keysPressed:{ESC:!1,LEFT:!1,RIGHT:!1,SPACE:!1,UP:!1},levelStartTime:null,objects:[],startTime:null}},initializeLevelAndStart:function(e,t){e="undefined"==typeof e?this.level:e,t="undefined"==typeof t?!0:t,t||!this.state?(this.state=this.getInitialState(),this.state=u[this.level](this.state)):this.state.currentStatus=d.CONTINUE,this.state.levelStartTime=Date.now(),this.state.startTime||(this.state.startTime=this.state.levelStartTime),this._preloadImagesForLevel(function(){this.render(),this._initializeGameListeners(),this.update()}.bind(this))},pauseLevel:function(e){e&&(this.state.currentStatus=e),this.state.keysPressed.ESC=!1,this.state.lastUpdated=null,this._removeGameListeners(),window.addEventListener("keydown",this._pauseListener),this._drawPauseScreen()},_pauseListener:function(e){if(32===e.keyCode&&!this._deactivated){e.preventDefault();var t=this.state.currentStatus===d.WIN||this.state.currentStatus===d.FAIL;this.initializeLevelAndStart(this.level,t),window.removeEventListener("keydown",this._pauseListener)}},_drawPauseScreen:function(){function t(e,t,s){s.save(),s.fillStyle="#FFFFFF",s.beginPath(),s.moveTo(e.x,e.y),s.lineTo(e.x,e.y-50),s.lineTo(e.x+100,e.y-100),s.lineTo(e.x+250,e.y-50),s.lineTo(e.x+200,e.y+50),s.lineTo(e.x,e.y),s.closePath(),s.shadowColor="rgba(0, 0, 0, 0.7)",s.shadowOffsetX=10,s.shadowOffsetY=10,s.fill(),s.restore(),s.font="16px PT Mono";for(var i=e.y-30,a=e.x+20,r=0;r<t.length;r++)s.fillText(t[r],a,i),i+=20}var e=[];if(!(!this.ctx instanceof CanvasRenderingContext2D)){switch(this.state.currentStatus){case d.WIN:e.push("Hey!"),e.push("You won!");break;case d.FAIL:e.push("Sorry<"),e.push("You failed!");break;case d.PAUSE:e.push("Game paused,"),e.push("Relax.");break;case d.INTRO:e.push("Welcome to the game!"),e.push("Press Space to start.")}t({x:400,y:150},e,this.ctx)}},_preloadImagesForLevel:function(e){if("undefined"==typeof this._imagesArePreloaded&&(this._imagesArePreloaded=[]),this._imagesArePreloaded[this.level])return void e();var t=[];this.state.objects.forEach(function(e){t.push(e.sprite),e.spriteReversed&&t.push(e.spriteReversed)});for(var s=t.length,i=t.length;s-->0;){var a=new Image;a.src=t[s],a.onload=function(){0===--i&&(this._imagesArePreloaded[this.level]=!0,e())}.bind(this)}},updateObjects:function(e){var t=this.state.objects.filter(function(e){return e.type===r.ME})[0];this.state.keysPressed.SHIFT&&(this.state.objects.push({direction:t.direction,height:24,speed:5,sprite:"img/fireball.gif",type:r.FIREBALL,width:24,x:t.direction&h.RIGHT?t.x+t.width:t.x-24,y:t.y+t.height/2}),this.state.keysPressed.SHIFT=!1),this.state.garbage=[];var s=this.state.objects.filter(function(t){return o[t.type](t,this.state,e),t.state===n.DISPOSED?(this.state.garbage.push(t),!1):!0},this);this.state.objects=s},checkStatus:function(){if(this.state.currentStatus===d.CONTINUE){this.commonRules||(this.commonRules=[function(e){var t=e.objects.filter(function(e){return e.type===r.ME})[0];return t.state===n.DISPOSED?d.FAIL:d.CONTINUE},function(e){return e.keysPressed.ESC?d.PAUSE:d.CONTINUE},function(e){return Date.now()-e.startTime>18e4?d.FAIL:d.CONTINUE}]);for(var s,e=this.commonRules.concat(c[this.level]),t=d.CONTINUE;t===d.CONTINUE&&e.length;)s=e.shift(),t=s(this.state);this.state.currentStatus=t}},setGameStatus:function(e){this.state.currentStatus!==e&&(this.state.currentStatus=e)},render:function(){this.ctx.clearRect(0,0,t,e),this.state.objects.forEach(function(e){if(e.sprite){var t=new Image(e.width,e.height);t.src=e.spriteReversed&&e.direction&h.LEFT?e.spriteReversed:e.sprite,this.ctx.drawImage(t,e.x,e.y,e.width,e.height)}},this)},update:function(){this.state.lastUpdated||(this.state.lastUpdated=Date.now());var e=(Date.now()-this.state.lastUpdated)/10;switch(this.updateObjects(e),this.checkStatus(),this.state.currentStatus){case d.CONTINUE:this.state.lastUpdated=Date.now(),this.render(),requestAnimationFrame(function(){this.update()}.bind(this));break;case d.WIN:case d.FAIL:case d.PAUSE:case d.INTRO:this.pauseLevel()}},_onKeyDown:function(e){switch(e.keyCode){case 37:this.state.keysPressed.LEFT=!0;break;case 39:this.state.keysPressed.RIGHT=!0;break;case 38:this.state.keysPressed.UP=!0;break;case 27:this.state.keysPressed.ESC=!0}e.shiftKey&&(this.state.keysPressed.SHIFT=!0)},_onKeyUp:function(e){switch(e.keyCode){case 37:this.state.keysPressed.LEFT=!1;break;case 39:this.state.keysPressed.RIGHT=!1;break;case 38:this.state.keysPressed.UP=!1;break;case 27:this.state.keysPressed.ESC=!1}e.shiftKey&&(this.state.keysPressed.SHIFT=!1)},_initializeGameListeners:function(){window.addEventListener("keydown",this._onKeyDown),window.addEventListener("keyup",this._onKeyUp)},_removeGameListeners:function(){window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("keyup",this._onKeyUp)}},f.Verdict=d,f}();